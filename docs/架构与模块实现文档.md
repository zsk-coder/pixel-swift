# PixelSwift 架构与模块实现文档

> **版本**: v0.8.0  
> **更新日期**: 2026-02-17  
> **关联文档**: [项目进度报告](./项目进度报告.md) · [产品需求文档](./产品需求文档.md) · [技术规格说明书](./技术规格说明书.md)

---

## 一、整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        Pages（页面层）                            │
│  index.vue · converter.vue · compress-image.vue · resize-image  │
├─────────────────────────────────────────────────────────────────┤
│                     Components（组件层）                          │
│  FileUploader · FileList · QualitySlider · CompareSlider · ...  │
├─────────────────────────────────────────────────────────────────┤
│                     Composables（逻辑层）                        │
│  useImageProcessor · useFileUpload · useDownload · useBatch...  │
├─────────────────────────────────────────────────────────────────┤
│                     Workers（线程层）                             │
│  imageProcessor.worker.ts（OffscreenCanvas 图片处理）            │
├─────────────────────────────────────────────────────────────────┤
│                     Utils（工具层）                               │
│  constants.ts · fileNaming.ts · formatDetector.ts               │
├─────────────────────────────────────────────────────────────────┤
│                   Infrastructure（基础设施）                      │
│  Nuxt 3 · TailwindCSS · Element Plus · i18n · color-mode       │
└─────────────────────────────────────────────────────────────────┘
```

### 数据流

```
用户选择文件 → FileUploader.vue
    ↓ emit('files', File[])
页面组件 (converter/compressor/resizer)
    ↓ 调用 composable
useImageProcessor.processImage(file, options)
    ↓ Canvas API
OffscreenCanvas → convertToBlob
    ↓ 返回 ProcessResult
页面组件更新 UI → 用户下载
```

---

## 二、Composables 模块详解

### 2.1 `useImageProcessor.ts` — 核心图片处理引擎

**职责**: 单图/批量图片处理（转换、压缩、调整大小）

| 接口 | 说明 |
|------|------|
| `processImage(file, options)` → `ProcessResult` | 处理单张图片 |
| `processBatch(files, options, onProgress)` → `ProcessResult[]` | 批量顺序处理 |
| `isProcessing` (readonly ref) | 处理状态 |
| `progress` (readonly ref) | 进度 0-100 |
| `error` (readonly ref) | 错误信息 |

**实现方式**:
1. `createImageBitmap(file)` 解码图片
2. 计算输出尺寸（含锁定比例逻辑）
3. `OffscreenCanvas` + `ctx.drawImage()` 绘制
4. `canvas.convertToBlob({ type, quality })` 编码
5. 返回 `{ blob, originalSize, processedSize, width, height, format, duration }`

**类型定义**:
```typescript
interface ProcessOptions {
  action: "convert" | "compress" | "resize"
  outputFormat?: "jpg" | "png" | "webp" | "pdf"
  quality?: number        // 1-100
  width?: number
  height?: number
  keepAspectRatio?: boolean
  progressive?: boolean
}

interface ProcessResult {
  blob: Blob
  originalSize: number
  processedSize: number
  width: number
  height: number
  format: string
  duration: number  // ms
}
```

---

### 2.2 `useFileUpload.ts` — 文件上传与验证

**职责**: 管理文件上传状态、格式/大小验证、预览生成

| 接口 | 说明 |
|------|------|
| `addFiles(rawFiles)` | 添加文件（含验证） |
| `removeFile(id)` | 删除单个文件 |
| `updateFileStatus(id, updates)` | 更新文件状态 |
| `clearAll()` | 清空所有文件 |
| `files` (readonly ref) | 文件列表 |
| `config` | 生效的配置 |

**实现方式**:
1. 接收 `File[]`，逐个验证大小 (≤50MB) 和扩展名
2. 生成唯一 ID (`file_${Date.now()}_${random}`)
3. 通过 `URL.createObjectURL` 生成预览
4. `onUnmounted` 时自动释放所有 ObjectURL

**类型定义**:
```typescript
interface UploadFile {
  id: string
  file: File
  name: string
  size: number
  format: string
  preview: string        // ObjectURL
  status: "pending" | "processing" | "done" | "error"
  progress: number
  error?: string
}
```

---

### 2.3 `useDownload.ts` — 文件下载与 ZIP 打包

**职责**: 单文件下载、批量 ZIP 打包下载、输出文件命名

| 接口 | 说明 |
|------|------|
| `downloadFile(blob, filename)` | 单文件下载 |
| `downloadAsZip(files, zipName)` | ZIP 批量下载 |
| `generateFileName(original, action, meta)` | 输出文件命名 |
| `generateZipName(action)` | ZIP 文件命名 |

**实现方式**:
- **单文件**: `URL.createObjectURL` → 创建 `<a>` → `click()` → 清理
- **ZIP**: 动态 `import("jszip")`（按需加载，不打入主包）→ `zip.generateAsync` → 下载
- **命名规则** (遵循 PRD 3.2.2):
  - 转换: `{原名}.{新格式}`
  - 压缩: `{原名}_compressed.{格式}`
  - 调整: `{原名}_{宽}x{高}.{格式}`
  - 批量: `pixelswift_{功能}_{日期}.zip`

---

### 2.4 `useBatchProcess.ts` — 批量处理编排

**职责**: 协调 `useFileUpload` 和 `useImageProcessor`，管理批量处理流程

| 接口 | 说明 |
|------|------|
| `processAll(files, options, onFileUpdate)` | 顺序处理所有待处理文件 |
| `downloadAll(files, action)` | 下载所有已完成的文件 |
| `isProcessing` / `currentIndex` / `results` | 状态 |

**实现方式**:
1. 过滤 `status === "pending"` 的文件
2. 逐个调用 `processImage`，每完成一个通过 `onFileUpdate` 回调更新 UI
3. 错误被捕获并标记到单个文件，不影响后续文件
4. `downloadAll` 收集所有完成的结果，调用 `downloadAsZip`

---

### 2.5 `useTheme.ts` — 暗色模式

**职责**: 封装 `@nuxtjs/color-mode`

| 接口 | 说明 |
|------|------|
| `isDark` (computed) | 当前是否暗色 |
| `toggleTheme()` | 切换暗色/浅色 |

---

## 三、页面模块详解

### 3.1 首页 (`index.vue`)

| 区域 | 说明 |
|------|------|
| Hero | 标题 + 副标题 + 3 个功能入口卡片 |
| Why PixelSwift | 4 个亮点（极速/安全/免费/批量） |
| FAQ | 3 个常见问题 + JSON-LD Schema |
| CTA | 底部行动号召 |

**SEO**: `useHead` + FAQ Schema (`defineFAQPage`)

---

### 3.2 通用转换器 (`converter.vue`)

**代码量**: 685 行 (24KB)

| 功能 | 实现 |
|------|------|
| 格式选择 | ElSelect 下拉 (JPG/PNG/WebP) |
| 质量滑块 | ElSlider (PNG 时隐藏, 显示"无损") |
| 批量文件列表 | FileList 组件 |
| 处理 | `useImageProcessor.processImage` |
| 下载 | `useDownload.downloadFile` / `downloadAsZip` |

**状态流**:
```
上传文件 → rawFiles[] + fileItems[]
    → 点击转换 → 逐个 processImage → 更新 fileItems 状态
    → 完成后可单独下载或 ZIP 打包
```

---

### 3.3 图片压缩器 (`compress-image.vue`)

**代码量**: 1504 行 (57KB) — 最复杂的页面

| 功能 | 实现 |
|------|------|
| **双模式** | 自动检测: 1张=单图对比模式, 多张=批量模式 |
| 单图模式 | 左右对比预览 + CompareSlider 滑动对比 |
| 批量模式 | FileList + 点击某项查看对比详情 |
| 压缩预设 | 4 档按钮 (30/60/80/95) |
| 质量调节 | ElSlider, watch 变化时 debounce 500ms 重压缩 |
| 输出格式 | PNG → 自动转 WebP（压缩效果更好） |

**关键逻辑 — 单图/多图自动切换**:
```
ElUpload on-change 逐个触发
    → pendingModeCheck (setTimeout 100ms)
    → afterAllFilesAdded()
    → rawFiles.length === 1 ? 单图模式 : 批量模式
```

**桌面/移动端双布局**:
- 桌面端 (lg+): 左预览 + 右设置面板
- 移动端: 垂直堆叠

---

### 3.4 尺寸调整器 (`resize-image.vue`)

**代码量**: 1027 行 (41KB)

| 功能 | 实现 |
|------|------|
| 像素模式 | ElInputNumber (宽/高) + 锁定比例 |
| 百分比模式 | ElSlider (1-500%) |
| 宽高比预设 | 5 个预设按钮 |
| 旋转 | ±90° (CSS transform 预览 + Canvas 实际处理) |
| 翻转 | 水平/垂直 (scaleX/Y) |
| 尺寸预估 | 基于像素比计算估计大小 |

**Transform 处理** (`applyTransforms`):
```
创建临时 Canvas
    → 根据 rotation/flipH/flipV 设置 ctx.transform
    → drawImage 到旋转后的 Canvas
    → 返回 Blob
```

---

## 四、组件层详解

### 4.1 通用组件 (`components/common/`)

| 组件 | 代码量 | 说明 |
|------|--------|------|
| `AppHeader.vue` | 7.1KB | 导航栏, 语言切换, 暗色模式, 移动端汉堡菜单 |
| `FileUploader.vue` | 4.3KB | ElUpload 封装, 拖拽+点击+粘贴(Ctrl+V) |
| `FileList.vue` | 3.8KB | 文件列表展示, 缩略图/大小/状态/操作按钮 |
| `QualitySlider.vue` | 3.0KB | 质量滑块 + 低/高标签 |
| `CompareSlider.vue` | 2.7KB | 拖拽分隔线图片对比, PointerEvents |
| `AppFooter.vue` | 2.2KB | 页脚, 导航链接, 版权 |
| `ErrorToast.vue` | 1.8KB | 错误提示 Toast |
| `AdSlot.vue` | 1.2KB | 广告位占位组件 |
| `ProgressBar.vue` | 0.8KB | 进度条 |
| `DownloadButton.vue` | 0.6KB | 下载按钮 |
| `ImagePreview.vue` | 0.5KB | 图片预览 |

---

## 五、工具层详解

### 5.1 `constants.ts`

全局常量定义，使用 `as const` 确保精确类型推断:

| 常量 | 值 | 用途 |
|------|------|------|
| `MAX_FILE_SIZE` | 50MB | 单文件大小限制 |
| `MAX_FILE_COUNT` | 20 | 批量文件数量限制 |
| `INPUT_FORMATS` | jpg/jpeg/png/webp/bmp/tif/tiff | 支持的输入格式 |
| `OUTPUT_FORMATS` | jpg/png/webp/pdf | 支持的输出格式 |
| `MIME_MAP` | Record\<string, string\> | 扩展名→MIME映射 |
| `COMPRESSION_PRESETS` | 30/60/80/95 | 压缩预设值 |
| `RATIO_PRESETS` | 1:1, 4:3, 16:9, 3:2, 9:16 | 宽高比预设 |
| `PERFORMANCE` | maxProcessingTime/debounceDelay | 性能阈值 |

### 5.2 `fileNaming.ts`

文件命名工具函数（遵循 PRD 3.2.2）。

### 5.3 `formatDetector.ts`

通过文件扩展名和 Magic Bytes 检测图片格式。

---

## 六、Web Worker

### `imageProcessor.worker.ts`

**通信协议**:

```typescript
// 输入
interface WorkerInput {
  id: string
  action: "convert" | "compress" | "resize"
  buffer: ArrayBuffer
  options: { outputFormat?, quality?, width?, height?, keepAspectRatio? }
}

// 输出
interface WorkerOutput {
  id: string
  type: "progress" | "complete" | "error"
  progress?: number
  result?: { buffer: ArrayBuffer, width, height, format }
  error?: string
}
```

**当前状态**: Worker 代码已就绪，但页面组件直接调用主线程的 `useImageProcessor`（`processImage` 使用 `OffscreenCanvas` 在主线程处理），尚未切换到 Worker 通道。

---

## 七、基础设施配置

| 配置文件 | 关键点 |
|----------|--------|
| `nuxt.config.ts` | 模块: tailwindcss + i18n + color-mode + schema-org + element-plus |
| `tailwind.config.ts` | 自定义设计 Token (品牌色/字体/间距/圆角/阴影) |
| SCSS | `_variables.scss` (断点/动效时长) + `_mixins.scss` (respond-to/hover-lift) |
| i18n | 8 种语言, `prefix_except_default` 策略, 浏览器语言检测 |
